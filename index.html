<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Meta tags for character encoding and responsive design -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Vue.js library -->
    <script src="https://unpkg.com/vue@2.7.8/dist/vue.js"></script>

    <!-- Link to the external stylesheet -->
    <link rel="stylesheet" href="store.css">

    <!-- Title of the webpage -->
    <title>Web Store</title>
</head>

<body>
    <!-- Root Vue instance -->
    <div id="webstore">
        <!-- Main store title -->
        <h1>{{ message }}</h1>

        <!-- Button to navigate to the checkout page -->
        <button v-on:click="showCheckout" :disabled="cart.length === 0">
            {{ cart.length }} items for Checkout
        </button>

        <main>
            <!-- Product Page: Display products -->
            <div v-if="showProduct">
                <!-- Sorting Options -->
                <div class="sorting-options">
                    <label for="sort-key">Sort by:</label>
                    <select id="sort-key" v-model="sortKey" @change="sortProducts">
                        <option value="title">Name</option>
                        <option value="price">Price</option>
                        <option value="rating">Rating</option>
                        <option value="availableInventory">Availability</option>
                        <option value="location">Location</option>
                    </select>

                    <label for="sort-order">Order:</label>
                    <select id="sort-order" v-model="sortOrder" @change="sortProducts">
                        <option value="asc">Ascending</option>
                        <option value="desc">Descending</option>
                    </select>
                </div>

                <!-- Search Bar -->
                <div class="search-bar">
                    <input type="text" v-model="searchQuery" placeholder="Search products..." @input="fetchProducts" />
                </div>

                <!-- Product List -->
                <div class="product-list">
                    <!-- Loop through products and display each one -->
                    <figure v-for="product in products" :key="product._id">
                        <img :src="product.image" :alt="product.title + ' image'">
                        <h2>{{ product.title }}</h2>
                        <p>{{ product.description }}</p>
                        <p>Price: Rs {{ product.price }}</p>
                        <p>Location: {{ product.location }}</p>
                        <p>Available inventory: {{ product.availableInventory }}</p>

                        <!-- 5-Star Rating -->
                        <div>
                            <span v-for="n in product.rating" :key="n">⭐</span>
                            <span v-for="n in 5 - product.rating" :key="n" class="empty-star">☆</span>
                        </div>

                        <!-- Add to Cart Button -->
                        <input type="button" v-on:click="addItemToCart(product)" v-if="canAddToCart(product)"
                            value="Add to cart">
                        <input type="button" value="Add to cart" disabled v-else>
                    </figure>
                </div>
            </div>

            <!-- Checkout Page: Form to submit orders -->
            <div v-else>
                <h1>Checkout</h1>

                <!-- Checkout Form -->
                <form class="checkout-form" @submit.prevent="submitForm">
                    <label>
                        Name:
                        <input type="text" v-model="checkout.name" required>
                    </label>
                    <label>
                        Surname:
                        <input type="text" v-model="checkout.surname" required>
                    </label>
                    <label>
                        Phone Number:
                        <input type="tel" v-model="checkout.phone" required>
                    </label>

                    <!-- Country selection -->
                    <label>
                        Country:
                        <select v-model="checkout.country" required>
                            <option value="USA">USA</option>
                            <option value="Canada">Canada</option>
                            <option value="UK">UK</option>
                            <option value="Australia">Australia</option>
                            <option value="Germany">Germany</option>
                        </select>
                    </label>

                    <!-- Gift checkbox -->
                    <label>
                        Is it a gift?:
                        <input type="checkbox" v-model="checkout.isGift">
                        <span v-if="checkout.isGift">This is a gift</span>
                    </label>

                    <!-- Summary of cart -->
                    <p>Total items: {{ cart.length }}</p>
                    <p>Total price: Rs {{ totalPrice }}</p>

                    <!-- Products in Cart -->
                    <h3>Products in Cart:</h3>
                    <div class="product-list">
                        <figure v-for="product in cart" :key="product._id">
                            <img :src="product.image" :alt="product.title + ' image'">
                            <h2>{{ product.title }}</h2>
                            <p>{{ product.description }}</p>
                            <p>Price: Rs {{ product.price }}</p>
                            <p>Location: {{ product.location }}</p>
                            <p>Available inventory: {{ product.availableInventory }}</p>

                            <!-- Remove Button -->
                            <button type="button" v-on:click="removeItemFromCart(product.title)">Remove</button>
                        </figure>
                    </div>

                    <!-- Form Buttons -->
                    <button type="button" v-on:click="showCheckout">Return to store</button>
                    <button type="submit" :disabled="!isFormComplete">Submit</button>
                </form>

                <!-- Display Submitted Data -->
                <div v-if="submitted">
                    <h2>Submitted Data:</h2>
                    <p><strong>Name:</strong> {{ checkout.name }}</p>
                    <p><strong>Surname:</strong> {{ checkout.surname }}</p>
                    <p><strong>Country:</strong> {{ checkout.country }}</p>
                    <p><strong>Is it a gift?:</strong> {{ checkout.isGift ? 'Yes' : 'No' }}</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Vue.js Application Script -->
    <script>
        let webstore = new Vue({
            el: '#webstore',
            data: {
                message: "Welcome to the Web Store!", // Main title
                products: [], // Product list fetched from the backend
                cart: [], // Products added to the cart
                searchQuery: '', // Search input
                sortKey: 'title', // Sorting key
                sortOrder: 'asc', // Sorting order
                showProduct: true, // Toggle between product page and checkout page
                checkout: {
                    name: '',
                    surname: '',
                    phone: '',
                    country: '',
                    isGift: false
                },
                submitted: false // Flag to show submitted data
            },
            methods: {
                // Fetch products from the backend
                fetchProducts: async function () {
                    try {
                        const response = await fetch(
                            `https://courses-website-coursework1.onrender.com/collections/products/search?search=${this.searchQuery}&sortKey=${this.sortKey}&sortOrder=${this.sortOrder}`
                        );

                        if (response.ok) {
                            this.products = await response.json(); // Update products array
                        } else {
                            console.error('Failed to fetch products:', await response.text());
                        }
                    } catch (error) {
                        console.error('Error fetching products:', error);
                    }
                },

                // Update products after sorting options change
                sortProducts: function () {
                    this.fetchProducts();
                },

                // Add a product to the cart
                addItemToCart: function (product) {
                    if (product.availableInventory > 0) {
                        this.cart.push(product);
                        product.availableInventory--; // Reduce inventory
                    }
                },

                // Remove a product from the cart
                removeItemFromCart: function (productTitle) {
                    const productIndex = this.cart.findIndex(product => product.title === productTitle);
                    if (productIndex !== -1) {
                        const product = this.cart[productIndex];
                        this.cart.splice(productIndex, 1);
                        product.availableInventory++; // Restore inventory
                    }
                },

                // Toggle between the product page and the checkout page
                showCheckout: function () {
                    this.showProduct = !this.showProduct;
                },

                // Submit the checkout form
                submitForm: async function () {
                    const orderId = `ORD-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
                    const orderData = {
                        orderId: orderId,
                        name: this.checkout.name,
                        surname: this.checkout.surname,
                        phone: this.checkout.phone,
                        totalPrice: this.totalPrice,
                        courses: this.cart.map(product => ({
                            title: product.title,
                            price: product.price
                        }))
                    };

                    try {
                        const response = await fetch('https://courses-website-coursework1.onrender.com/collections/orders', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(orderData)
                        });

                        if (response.ok) {
                            alert('Order submitted successfully!');
                            this.checkout = {
                                name: '',
                                surname: '',
                                phone: '',
                                country: '',
                                isGift: false
                            };
                            this.cart = [];
                            this.showProduct = true;
                            this.submitted = false;
                        } else {
                            alert('Error submitting order: ' + (await response.json()).error);
                        }
                    } catch (error) {
                        alert('Failed to submit order.');
                    }
                },

                // Check if a product can be added to the cart
                canAddToCart: function (product) {
                    return product.availableInventory > 0;
                }
            },

            computed: {
                // Calculate total price of items in the cart
                totalPrice: function () {
                    return this.cart.reduce((sum, product) => sum + product.price, 0);
                },

                // Check if the checkout form is complete
                isFormComplete: function () {
                    return this.checkout.name && this.checkout.surname && this.checkout.country;
                }
            },

            // Fetch initial products when the page loads
            mounted: function () {
                this.fetchProducts();
            }
        });
    </script>
</body>

</html>
