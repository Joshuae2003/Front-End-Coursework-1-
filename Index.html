<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/vue@2.7.8/dist/vue.js"></script>
    <link rel="stylesheet" href="store.css">
    <title>Web Store</title>
</head>

<body>
    <div id="webstore">
        <h1>{{ message }}</h1>
        <button v-on:click="showCheckout" :disabled="cart.length === 0">{{ cart.length }} items for Checkout</button>
        <main>
            <!-- Product Page -->
            <div v-if="showProduct">
                <!-- Sorting Buttons -->
                <div class="sorting-options">
                    <button @click="sortProducts('availability')">Sort by Availability</button>
                    <button @click="sortProducts('rating')">Sort by Rating</button>
                    <button @click="sortProducts('price')">Sort by Price</button>
                </div>

                <!-- Search Box -->
                <div class="search-bar">
                    <input type="text" v-model="searchQuery" placeholder="Search products...">
                </div>

                <div class="product-list">
                    <figure v-for="product in filteredProducts" :key="product.id">
                        <img :src="product.image" :alt="product.title + ' image'">
                        <h2>{{ product.title }}</h2>
                        <p>{{ product.description }}</p>
                        <p>Price: {{ product.price }}</p>
                        <p>Available inventory: {{ product.availableInventory }}</p>

                        <!-- 5-Star Rating -->
                        <div>
                            <span v-for="n in product.rating" :key="n">⭐</span>
                            <span v-for="n in 5 - product.rating" :key="n" class="empty-star">☆</span>
                        </div>

                        <!-- Add to Cart Button -->
                        <input type="button" v-on:click="addItemToCart(product)" v-if="canAddToCart(product)"
                            value="Add to cart">
                        <input type="button" value="Add to cart" disabled v-else>
                    </figure>
                </div>
            </div>

            <!-- Checkout Page -->
            <div v-else>
                <h1>Checkout</h1>
                <form class="checkout-form" @submit.prevent="submitForm">
                    <label>
                        Name:
                        <input type="text" v-model="checkout.name" required>
                    </label>
                    <label>
                        Surname:
                        <input type="text" v-model="checkout.surname" required>
                    </label>
                    <label>
                        Country:
                        <select v-model="checkout.country" required>
                            <option value="USA">USA</option>
                            <option value="Canada">Canada</option>
                            <option value="UK">UK</option>
                            <option value="Australia">Australia</option>
                            <option value="Germany">Germany</option>
                        </select>
                    </label>
                    <label>
                        Is it a gift?:
                        <input type="checkbox" v-model="checkout.isGift">
                        <span v-if="checkout.isGift">This is a gift</span>
                    </label>
                    <p>Total items: {{ cart.length }}</p>
                    <p>Total price: {{ totalPrice }}</p>

                    <!-- Display products in cart -->
                    <h3>Products in Cart:</h3>
                    <ul>
                        <li v-for="(count, product) in cartSummary" :key="product">
                            {{ product }} - Quantity: {{ count }}
                            <button @click="removeItemFromCart(product)">Remove</button>
                        </li>
                    </ul>

                    <button type="button" @click="showCheckout">Return to store</button>
                    <button type="submit" :disabled="!isFormComplete">Submit</button>
                </form>

                <!-- Display submitted data -->
                <div v-if="submitted">
                    <h2>Submitted Data:</h2>
                    <p><strong>Name:</strong> {{ checkout.name }}</p>
                    <p><strong>Surname:</strong> {{ checkout.surname }}</p>
                    <p><strong>Country:</strong> {{ checkout.country }}</p>
                    <p><strong>Is it a gift?:</strong> {{ checkout.isGift ? 'Yes' : 'No' }}</p>
                </div>
            </div>
        </main>
    </div>

    <script src="products.js"></script>
    <script>
        let webstore = new Vue({
            el: '#webstore',
            data: {
                message: "Welcome to the Web Store!",
                products: productData,
                cart: [],
                showProduct: true,
                checkout: {
                    name: '',
                    surname: '',
                    country: '',
                    isGift: false
                },
                submitted: false,
                searchQuery: '',
                sortKey: ''
            },
            methods: {
                addItemToCart: function (product) {
                    if (product.availableInventory > 0) {
                        this.cart.push(product);
                        product.availableInventory--;
                    }
                },
                showCheckout: function () {
                    this.showProduct = !this.showProduct;
                },
                submitForm: function () {
                    this.submitted = true;
                },
                canAddToCart: function (product) {
                    return product.availableInventory > 0;
                },
                sortProducts: function (key) {
                    this.sortKey = key;
                },
                removeItemFromCart: function (productTitle) {
                    // Find the product in the cart
                    const productIndex = this.cart.findIndex(product => product.title === productTitle);
                    if (productIndex !== -1) {
                        const product = this.cart[productIndex];
                        this.cart.splice(productIndex, 1);
                        product.availableInventory++;
                    }
                }
            },
            computed: {
                filteredProducts: function () {
                    let products = this.products.filter(product => {
                        return product.title.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
                            product.description.toLowerCase().includes(this.searchQuery.toLowerCase());
                    });

                    if (this.sortKey === 'availability') {
                        return products.sort((a, b) => b.availableInventory - a.availableInventory);
                    } else if (this.sortKey === 'rating') {
                        return products.sort((a, b) => b.rating - a.rating);
                    } else if (this.sortKey === 'price') {
                        return products.sort((a, b) => a.price - b.price);
                    }

                    return products;
                },
                totalPrice: function () {
                    return this.cart.reduce((sum, product) => sum + product.price, 0);
                },
                isFormComplete: function () {
                    return this.checkout.name && this.checkout.surname && this.checkout.country;
                },
                totalPrice: function () {
                    return this.cart.reduce((sum, product) => sum + product.price, 0);
                },
                isFormComplete: function () {
                    return this.checkout.name && this.checkout.surname && this.checkout.country;
                },
                cartSummary: function () {
                    let summary = {};
                    this.cart.forEach(product => {
                        if (summary[product.title]) {
                            summary[product.title]++;
                        } else {
                            summary[product.title] = 1;
                        }
                    });
                    return summary;
                }
            }
        });
    </script>
</body>

</html>